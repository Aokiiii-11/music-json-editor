## 问题与目标
- 修复两大缺陷：
  - 原文符号被误删：现有按 `|` 分隔的清理逻辑会截断合法内容；未处理 `丨/｜` 等相似字符。
  - 遍历清除安全隐患：深层递归、无边界校验，存在栈风险与类型误判。
- 目标：以“双输入源+结构化匹配+安全导出”为核心，确保符号完整保留、流程安全可控、与现有编辑能力兼容。

## 总体架构
- 双输入源：
  - 原文 JSON（可编辑，保留所有符号与格式）。
  - 中文译文 JSON（只作参考，不写回原文字段）。
- 结构化对齐：以“标题路径”进行精准匹配，不再依赖字符串分隔符。
- 独立导出：仅导出“纯净原文 JSON”；译文单独存储与引用。

## 现状梳理与改造点
- 清理逻辑：`App.tsx:152-166` 的 `cleanData` 使用 `obj.split('|')[0].trim()` 截断字符串。
- 编辑组件：`components/JsonEditor.tsx:120-166` 等使用 `safeValue.split('|')` 维护“英文 | 中文”。
- 导出功能：`App.tsx:168-213` 依据 `clean` 选择导出双语或清理版。
- 自动翻译：`services/geminiService.ts:102-182` 将整份 JSON 翻译成“英文 | 中文”。
- 结论：当前实现以“同字段内合并双语”为核心；我们将转为“原文与译文分离 + 路径对齐”。

## UI与输入源改造
- 新增组件：`components/TranslationJsonInput.tsx`
  - 顶部现有原文文本框保持不变（`App.tsx:319-327`）。
  - 新增一个独立的 JSON 文本框用于粘贴/导入“纯中文译文 JSON”。
  - 支持选择文件导入与手动粘贴，实时校验与结果提示。
- 视觉联动：侧边栏/浮层展示“匹配统计与异常项列表”（缺失/多余/冲突）。
- 编辑行为：继续在底部可视化编辑器编辑“原文 JSON”的字段值，译文仅用于对照显示。

## 数据模型与验证
- 新增数据结构：
  - `TranslationMap`: `Record<string, string>`，key 为“标题路径”，value 为中文文本。
  - `PathNode`: `{ path: string[], key?: string, valueType: 'string|object|array', title?: string }`。
- 验证流程：
  - 解析两份 JSON，生成结构树（只读）。
  - 逐节点比对：
    - 路径一致、类型一致通过；
    - 缺失/多余节点记录，显示在 UI；
    - 值类型不一致标记为错误。
- JSON 校验：语法解析、顶层结构是否符合 `MusicData` 的基本形态（使用轻量 Schema 校验或类型守卫）。

## 标题路径匹配算法
- 路径定义：以 JSON 键链与数组索引拼接的路径（例如 `global_dimension.description`、`section_dimension[3].lyrics`）。
- 小标题层级：
  - `Global Dimension` 下的 `description/fact_keywords/...` 直接路径；
  - `Timeline Analysis` 下的 `section_dimension[i].{description,lyrics,keywords,...}`。
- 算法步骤：
  - 从原文 JSON 构建所有可翻译的“标题路径”列表（仅字符串字段）。
  - 从译文 JSON 构建对应列表。
  - 以路径为主键进行对齐；当标题同名但路径不同时，不冲突。
- 冲突处理：
  - 同一路径出现多个译文条目：取首个并记录冲突；提供手动选择/合并入口。
  - 译文缺失：标记为“缺失”，用于导出前提示。
  - 译文多余：标记为“多余”，不影响原文编辑与导出。

## 导出模块重构
- 目标：仅导出“纯净原文 JSON”，保持原始符号与格式。
- 设计：
  - 移除按分隔符清理；导出直接取当前编辑后的原文数据结构。
  - 译文 JSON 独立保存（本地存储/另存文件），并在项目中仅引用，不嵌入到原文。
- 导出前校验：
  - 语法正确、可序列化。
  - 内容完整性（必须字段存在、类型正确）。
  - 若存在译文缺失/冲突，给予提示但不阻塞原文导出。

## 安全性与边界处理
- 替换现有清理递归：
  - 改为“类型守卫 + 迭代遍历（栈/队列）”方案，避免深递归栈溢出。
  - 明确仅对 `string` 字段进行读写；其余数据原样保留。
- 字符保留：
  - 不再对任何字符串进行 `split`/截断。
  - 所有特殊字符（包括 `|`、`丨`、`｜`、标点、格式标记）原样保留。
- 异常处理：
  - JSON 解析错误：不写状态，提示并引导修复。
  - 路径解析错误：忽略该译文项并记录。

## 单元测试与验证报告
- 测试框架：引入 `Vitest`（Vite 生态一致），配合 `@testing-library/react` 覆盖组件行为。
- 用例覆盖：
  - JSON 解析与校验：合法/非法、空值、类型不一致。
  - 路径匹配：嵌套、多级数组、重复标题、索引变更。
  - 冲突检测：同路径多译文、缺失、多余项。
  - 导出：仅原文、符号保留、格式正确（`JSON.stringify` 缩进）。
  - 性能：大 JSON（>1e4 节点）迭代遍历性能窗口与无栈溢出。
  - 组件：双输入框交互、异常列表展示、编辑原文联动导出。
- 验证报告：
  - 符号保留测试结果（包含 `|/丨/｜` 示例）。
  - 安全性测试（边界、异常、迭代防栈）。
  - 性能测试（节点规模与耗时曲线）。

## 兼容与迁移方案
- 读取兼容：
  - 若检测到旧格式（字段值包含 `英文 | 中文`），自动转换为：原文字段=管道左侧；译文映射=管道右侧。
  - 保留现有“Auto Translate”按钮，将其结果写入“译文映射”，不回写原文。
- UI 兼容：保留现有可视化编辑器布局与操作习惯；新增译文输入与对照区域不干扰原文编辑。
- 导出兼容：
  - “Save Progress” 改为保存两份：原文 JSON 与译文 JSON（分别下载）。
  - “Export Original (Clean)” 直接导出当前原文。

## 实施步骤
1. 引入测试栈：`vitest`、`@testing-library/react`，新增 `npm script:test`。
2. 新增 `utils/jsonPath.ts`（路径构建/解析）、`utils/validator.ts`（结构校验）、`utils/matcher.ts`（路径匹配与冲突检测）。
3. 新增 `components/TranslationJsonInput.tsx`（译文输入与校验结果展示）。
4. 改造 `App.tsx`：
   - 管理 `translationMap`/`translationJsonText` 状态；
   - 移除/废弃 `cleanData`，导出逻辑仅依赖原文数据；
   - 导出两份文件与导出前校验提示。
5. 改造 `JsonEditor.tsx`：
   - 移除 `split('|')` 双语合并逻辑，改为仅编辑原文；
   - 右侧显示来自 `translationMap` 的对照文本，不写回原文字段。
6. 保留 `geminiService.ts`：`translateJson` 的结果转为译文映射，不改原文。
7. 编写单元测试与端到端交互测试；补充性能基准脚本。
8. 生成验证报告（Markdown/JSON），并编写用户操作文档。

## 交付物
- 重构后的源代码（含新增工具与组件）。
- 测试用例与测试报告（符号保留/安全性/性能）。
- 功能验证报告（Markdown/JSON）。
- 用户操作文档（导入/编辑/匹配/导出流程）。